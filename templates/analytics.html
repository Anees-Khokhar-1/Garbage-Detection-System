<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Detection Analytics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { background: linear-gradient(180deg, #e9f7f1, #f3fbfb); }
    .hero { background: #198754; color: white; padding: 40px 0; text-align:center; margin-bottom: 25px; }
    #map { height: 420px; border-radius: 10px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); }
    .badge-small { background:#28a745; color:white; padding:6px 10px; border-radius:6px; }
    .badge-medium { background:#ffc107; color:#000; padding:6px 10px; border-radius:6px; }
    .badge-large { background:#dc3545; color:white; padding:6px 10px; border-radius:6px; }
    .table thead { background:#198754; color:white; }
    .table tbody tr.small { background:#e9f9ee; }
    .table tbody tr.medium { background:#fff9e6; }
    .table tbody tr.large { background:#fdecea; }
  </style>
</head>
<body>
  <div class="hero">
    <h1>Detection Analytics</h1>
    <p>Garbage classification & map (Muzaffarabad)</p>
  </div>

  <div class="container">

    <div class="row mb-4">
      <div class="col-md-4">
        <div class="card p-3 text-center">
          <h5>Small Garbage</h5>
          <div class="display-6 text-success">{{ small_count }}</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card p-3 text-center">
          <h5>Medium Garbage</h5>
          <div class="display-6 text-warning">{{ medium_count }}</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card p-3 text-center">
          <h5>Large Garbage</h5>
          <div class="display-6 text-danger">{{ large_count }}</div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-lg-7 mb-4">
        <h4>Garbage Detection Map â€” {{ city_name }}</h4>
        <div id="map"></div>
      </div>

      <div class="col-lg-5 mb-4">
        <h4>Counts</h4>
        <canvas id="countsChart" width="400" height="300"></canvas>

        <h4 class="mt-4">Legend</h4>
        <p><span class="badge-small"> &nbsp; </span> Small</p>
        <p><span class="badge-medium"> &nbsp; </span> Medium</p>
        <p><span class="badge-large"> &nbsp; </span> Large</p>
      </div>
    </div>

    <h4 class="mt-3">Detection Records</h4>
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Filename</th>
            <th>Detected Class</th>
            <th>Timestamp</th>
            <th>Location</th>
            <th>In-Charge</th>
          </tr>
        </thead>
        <tbody>
          {% for row in rows %}
            {% set det = (row[2] or '').lower() %}
            {% if 'small' in det %}
              {% set rclass='small' %}
            {% elif 'medium' in det %}
              {% set rclass='medium' %}
            {% elif 'large' in det %}
              {% set rclass='large' %}
            {% else %}
              {% set rclass='' %}
            {% endif %}
          <tr class="{{ rclass }}">
            <td style="max-width:350px; word-break:break-all">{{ row[1] }}</td>
            <td>
              {% if 'small' in det %}
                <span class="badge-small">Small</span>
              {% elif 'medium' in det %}
                <span class="badge-medium">Medium</span>
              {% elif 'large' in det %}
                <span class="badge-large">Large</span>
              {% else %}
                <span class="badge bg-secondary">Unknown</span>
              {% endif %}
            </td>
            <td>{{ row[3] }}</td>
            <td>{{ row[4] or "None" }}</td>
            <td>{{ row[5] or "None" }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="mt-4 mb-5 text-center">
      <a class="btn btn-primary" href="{{ url_for('index') }}">Upload more</a>
    </div>

  </div>

  <script>
    const mapData = {{ map_data_json | safe }};
    const cityCoords = [{{ city_coords[0] }}, {{ city_coords[1] }}];

    // Init map centered on Muzaffarabad
    var map = L.map('map').setView(cityCoords, 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Add markers
    mapData.forEach(item => {
      const lat = parseFloat(item.lat) || cityCoords[0];
      const lon = parseFloat(item.lon) || cityCoords[1];
      const color = item.color || "#6c757d";

      const marker = L.circleMarker([lat, lon], {
        radius: 8,
        fillColor: color,
        color: "#fff",
        weight: 1,
        opacity: 1,
        fillOpacity: 0.9
      }).addTo(map);

      const popupHtml = `<strong>${item.filename}</strong><br/>
                         Detected: ${item.detected}<br/>
                         Time: ${item.timestamp}<br/>
                         Location: ${item.location || 'None'}<br/>
                         In-Charge: ${item.incharge || 'None'}`;
      marker.bindPopup(popupHtml);
    });

    // Chart.js counts
    const ctx = document.getElementById('countsChart').getContext('2d');
    const data = {
      labels: ['Small Garbage', 'Medium Garbage', 'Large Garbage'],
      datasets: [{
        label: 'Detections',
        data: {{ chart_data }},
        backgroundColor: ['#28a745', '#ffc107', '#dc3545']
      }]
    };
    new Chart(ctx, { type: 'bar', data: data, options: { responsive: true } });

  </script>
</body>
</html>
